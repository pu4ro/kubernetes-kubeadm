---
- name: List all taints on master nodes
  command: kubectl describe node {{ item }}
  register: node_describe_output
  loop: "{{ groups['masters'] }}"
  when: remove_taints
  ignore_errors: true

- name: Parse taints from describe output
  set_fact:
    taints_output: "{{ taints_output | default([]) + [{'node': item.item, 'taints': item.stdout | regex_findall('Taints: (.*)')}] }}"
  loop: "{{ node_describe_output.results }}"
  when: 
    - item.rc == 0
    - "'Taints: <none>' not in item.stdout"

- name: Remove taints from master node
  command: kubectl taint nodes {{ item.node }} {{ taint.split(':')[0] }}-
  loop: "{{ taints_output }}"
  when:
    - remove_taints
    - "'NoSchedule' in item.taints"
  loop_control:
    loop_var: item
    extended: true