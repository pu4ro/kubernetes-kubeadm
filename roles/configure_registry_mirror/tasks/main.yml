---
# Configure Containerd Registry Mirror for Runway 2.0+
# IMPORTANT: This role is REQUIRED for Runway 2.0+ environments
#
# This role configures containerd to use internal registry mirrors
# for external container registries (docker.io, quay.io, registry.k8s.io, etc.)

- name: Ensure /etc/containerd/certs.d directory exists
  file:
    path: /etc/containerd/certs.d
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Generate base64 encoded basic auth credentials
  set_fact:
    registry_mirror_auth_b64: "{{ (registry_mirror_user + ':' + registry_mirror_password) | b64encode }}"
  no_log: true

- name: Display registry mirror configuration
  debug:
    msg: |
      Configuring registry mirrors:
      - Internal registry: {{ registry_mirror_host }}
      - Path prefix: {{ registry_mirror_path_prefix | default('none') }}
      - Registries: {{ registry_mirror_mappings.keys() | list | join(', ') }}

- name: Create registry-specific directories
  file:
    path: "/etc/containerd/certs.d/{{ item.key }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop: "{{ registry_mirror_mappings | dict2items }}"
  loop_control:
    label: "{{ item.key }}"

- name: Deploy hosts.toml for each registry
  template:
    src: hosts.toml.j2
    dest: "/etc/containerd/certs.d/{{ item.key }}/hosts.toml"
    owner: root
    group: root
    mode: '0644'
  loop: "{{ registry_mirror_mappings | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  vars:
    external_host: "{{ item.key }}"
    internal_repo: "{{ item.value }}"
    internal_repo_path: "{{ (registry_mirror_path_prefix + '/' + item.value) if registry_mirror_path_prefix else item.value }}"
    # docker.io uses different server/mirror URLs
    server_url: "{{ 'https://docker.io' if item.key == 'docker.io' else 'https://' + item.key }}"
    mirror_host: "{{ 'https://registry-1.docker.io' if item.key == 'docker.io' else 'https://' + item.key }}"
  register: hosts_toml_deployed

- name: Restart containerd service if configuration changed
  systemd:
    name: containerd
    state: restarted
  when: hosts_toml_deployed is changed

- name: Wait for containerd to be ready
  pause:
    seconds: 5
  when: hosts_toml_deployed is changed

- name: Verify containerd is running
  systemd:
    name: containerd
    state: started
  register: containerd_status

- name: Display configuration summary
  debug:
    msg: |
      Registry mirror configuration completed:
      - Configured registries: {{ registry_mirror_mappings | length }}
      - Configuration directory: /etc/containerd/certs.d
      - Containerd status: {{ 'running' if containerd_status.status.ActiveState == 'active' else 'not running' }}
