---

- name: Find all .repo files in /etc/yum.repos.d
  find:
    paths: /etc/yum.repos.d
    patterns: "*.repo"
  register: repo_files

- name: Remove all .repo files
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ repo_files.files }}"
  when: repo_files.matched > 0

# Configure local repository based on setup_local_repo settings
# Case 1: master1 with local file-based access
- name: Configure CentOS local yum-repo (master1 - use local file path)
  copy:
    content: |
      [centos-local]
      name=CentOS Local Repository
      baseurl=file://{{ yum_repo_directory }}
      enabled=1
      gpgcheck=0
      priority=1
    dest: /etc/yum.repos.d/centos-local.repo
  when:
    - setup_local_repo | default(false)
    - use_yum_repo_directory | default(false)
    - inventory_hostname == groups['masters'][0]

- name: Configure CentOS local ISO repo (master1 - use local file path)
  copy:
    content: |
      [centos-iso-baseos]
      name=CentOS ISO BaseOS Repository
      baseurl=file://{{ iso_mount_point }}/BaseOS
      enabled=1
      gpgcheck=0
      priority=1

      [centos-iso-appstream]
      name=CentOS ISO AppStream Repository
      baseurl=file://{{ iso_mount_point }}/AppStream
      enabled=1
      gpgcheck=0
      priority=1
    dest: /etc/yum.repos.d/centos-iso.repo
  when:
    - setup_local_repo | default(false)
    - use_iso_repo | default(false)
    - inventory_hostname == groups['masters'][0]

# Case 2: Other nodes with HTTP access to master1
- name: Configure CentOS local yum-repo (other nodes - use HTTP)
  copy:
    content: |
      [centos-local]
      name=CentOS Local Repository
      baseurl=http://{{ groups['masters'][0] }}:{{ yum_repo_web_port }}/yum-repo
      enabled=1
      gpgcheck=0
      priority=1
    dest: /etc/yum.repos.d/centos-local.repo
  when:
    - setup_local_repo | default(false)
    - use_yum_repo_directory | default(false)
    - inventory_hostname != groups['masters'][0]

- name: Configure CentOS local ISO repo (other nodes - use HTTP)
  copy:
    content: |
      [centos-iso-baseos]
      name=CentOS ISO BaseOS Repository
      baseurl=http://{{ groups['masters'][0] }}:{{ yum_repo_web_port }}/iso-repo/BaseOS
      enabled=1
      gpgcheck=0
      priority=1

      [centos-iso-appstream]
      name=CentOS ISO AppStream Repository
      baseurl=http://{{ groups['masters'][0] }}:{{ yum_repo_web_port }}/iso-repo/AppStream
      enabled=1
      gpgcheck=0
      priority=1
    dest: /etc/yum.repos.d/centos-iso.repo
  when:
    - setup_local_repo | default(false)
    - use_iso_repo | default(false)
    - inventory_hostname != groups['masters'][0]

# Case 3: No local repo setup - use external repo
- name: Configure CentOS repo (no local repo setup)
  copy:
    content: |
      [centos-local]
      name=CentOS Local Repository
      baseurl={{ repo_url.centos }}
      enabled=1
      gpgcheck=0
      priority=1
    dest: /etc/yum.repos.d/centos-local.repo
  when: not (setup_local_repo | default(false))
