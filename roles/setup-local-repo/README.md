# Local Repository Setup Role

This role configures a local HTTP repository server for RedHat/CentOS systems. It supports two types of repositories:

1. **Directory-based Repository**: Serves RPM packages from a local directory (e.g., `/opt/yum-repo`)
2. **ISO-based Repository**: Mounts and serves an ISO file or CD/DVD device via HTTP

## Features

- Automatic web server setup (httpd or nginx)
- Support for directory-based RPM repositories
- Support for ISO file or CD/DVD device mounting
- Automatic fstab configuration for persistent ISO mounts
- SELinux context configuration
- Firewall rules configuration
- Creates yum repository configuration files automatically

## Requirements

- RedHat/CentOS operating system
- Root or sudo access
- ISO file or CD/DVD device (for ISO-based repo)
- Directory with RPM packages (for directory-based repo)

## Configuration

Edit `group_vars/all.yml` to configure the local repository:

### Basic Configuration

```yaml
# Enable local repository setup
setup_local_repo: true

# Web server choice (httpd or nginx)
local_repo_web_server: "httpd"
yum_repo_web_port: 8080
```

### Directory-based Repository

```yaml
# Enable directory-based repository
use_yum_repo_directory: true
yum_repo_directory: "/opt/yum-repo"
```

### ISO-based Repository (from ISO file)

```yaml
# Enable ISO repository
use_iso_repo: true
iso_file_path: "/root/rhel-9.4-x86_64-dvd.iso"
iso_mount_point: "/mnt/cdrom"
use_iso_device: false
```

### ISO-based Repository (from CD/DVD device)

```yaml
# Enable ISO repository from device
use_iso_repo: true
iso_device: "/dev/sr0"
iso_mount_point: "/mnt/cdrom"
use_iso_device: true
```

## Usage

### Full Setup

Run the playbook with the local-repo tag:

```bash
ansible-playbook -i inventory.ini site.yml --tags local-repo
```

### Specific Components

```bash
# Setup web server only
ansible-playbook -i inventory.ini site.yml --tags web-server

# Setup yum-repo directory only
ansible-playbook -i inventory.ini site.yml --tags yum-repo-dir

# Setup ISO repository only
ansible-playbook -i inventory.ini site.yml --tags iso-repo

# Configure repository files only
ansible-playbook -i inventory.ini site.yml --tags repo-config
```

## Repository URLs

After setup, repositories will be available at:

- **Directory-based**: `http://<server_ip>:8080/yum-repo`
- **ISO-based**: `http://<server_ip>:8080/iso-repo`

## Repository Configuration Files

The role creates repository configuration files in `/etc/yum.repos.d/`:

- `local-yum-repo.repo` - For directory-based repository
- `local-iso-repo.repo` - For ISO-based repository (includes BaseOS and AppStream for RHEL 8/9)

## Example Configurations

### Example 1: Directory-based Repository Only

```yaml
setup_local_repo: true
use_yum_repo_directory: true
yum_repo_directory: "/opt/yum-repo"
use_iso_repo: false
local_repo_web_server: "httpd"
yum_repo_web_port: 8080
```

### Example 2: ISO File Repository Only

```yaml
setup_local_repo: true
use_yum_repo_directory: false
use_iso_repo: true
iso_file_path: "/root/rhel-9.4-x86_64-dvd.iso"
iso_mount_point: "/mnt/cdrom"
use_iso_device: false
local_repo_web_server: "httpd"
yum_repo_web_port: 8080
```

### Example 3: CD/DVD Device Repository

```yaml
setup_local_repo: true
use_yum_repo_directory: false
use_iso_repo: true
iso_device: "/dev/sr0"
iso_mount_point: "/mnt/cdrom"
use_iso_device: true
local_repo_web_server: "httpd"
yum_repo_web_port: 8080
```

### Example 4: Both Directory and ISO Repositories

```yaml
setup_local_repo: true
use_yum_repo_directory: true
yum_repo_directory: "/opt/yum-repo"
use_iso_repo: true
iso_file_path: "/root/rhel-9.4-x86_64-dvd.iso"
iso_mount_point: "/mnt/cdrom"
use_iso_device: false
local_repo_web_server: "httpd"
yum_repo_web_port: 8080
```

## Troubleshooting

### Check web server status

```bash
systemctl status httpd
# or
systemctl status nginx
```

### Check mount status

```bash
mount | grep cdrom
df -h /mnt/cdrom
```

### Check repository configuration

```bash
yum repolist
# or
dnf repolist
```

### Test repository access

```bash
curl http://localhost:8080/yum-repo/
curl http://localhost:8080/iso-repo/
```

### Check SELinux contexts

```bash
ls -lZ /opt/yum-repo
ls -lZ /mnt/cdrom
```

## Notes

- The role automatically adds the ISO mount to `/etc/fstab` for persistence across reboots
- SELinux contexts are automatically configured if SELinux is enabled
- Firewall rules are automatically configured for the specified port
- For RHEL 8/9 ISO repositories, the role creates configurations for BaseOS and AppStream
- The `createrepo` package is automatically installed for directory-based repositories

## Author

Generated by Ansible automation
