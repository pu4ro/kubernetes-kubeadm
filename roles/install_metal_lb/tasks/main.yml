- name: Check if metallb is already installed
  community.kubernetes.helm_info:
    name: metallb
    namespace: metallb-system
  register: metallb

- name: Get kube-proxy ConfigMap
  command: kubectl get configmap kube-proxy -n kube-system -o yaml
  register: kube_proxy_config

- name: Set strictARP to true
  copy:
    content: "{{ kube_proxy_config.stdout | regex_replace('strictARP: false', 'strictARP: true') }}"
    dest: "/tmp/kube-proxy-config.yaml"
  when: '"strictARP: false" in kube_proxy_config.stdout'

- name: Apply the modified ConfigMap
  command: kubectl apply -f /tmp/kube-proxy-config.yaml -n kube-system
  when: '"strictARP: false" in kube_proxy_config.stdout'

  register: patch_result
  when: metallb.status is undefined or ('failed' in metallb.status)

- name: Verify if the patch was applied
  debug:
    msg: "The kube-proxy ConfigMap was patched successfully."
  when: patch_result is changed and metallb.status is undefined or ('failed' in metallb.status)

- name: Add metallb repository to Helm
  community.kubernetes.helm_repository:
    name: metallb
    repo_url: http://{{ helm_repo_ip }}/metallb
    state: present
  

- name: Install metallb Helm Chart
  community.kubernetes.helm:
    name: metallb
    chart_ref: metallb/metallb
    release_namespace: metallb-system
    create_namespace: true
  when: metallb.status is undefined or ('failed' in metallb.status)


- name: Pause for 5 seconds
  pause:
    seconds: 5

- name: Wait for all metallb pods to be ready
  shell: >
    kubectl get pods -n metallb-system -o custom-columns=:status.phase --no-headers| grep operator | grep -v Running | grep -v Completed || true
  register: not_running_rook_pods
  until: not_running_rook_pods.stdout == ""
  retries: 20
  delay: 60
  become: true

- name: Deploy MetalLB configuration from template
  template:
    src: metallb_config.yaml.j2
    dest: "/tmp/metallb_config.yaml"

- name: Pause for 5 seconds
  pause:
    seconds: 5

- name: Apply MetalLB configuration
  command: kubectl apply -f /tmp/metallb_config.yaml

- name: Clean up MetalLB configuration file from local
  file:
    path: "/tmp/metallb_config.yaml"
    state: absent
