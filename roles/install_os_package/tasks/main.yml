---
# Cross-platform package installation
- name: Update package cache (Debian/Ubuntu)
  apt:
    update_cache: yes
    cache_valid_time: 3600
    update_cache_retries: 5
    update_cache_retry_max_delay: 30
  when: ansible_os_family == "Debian"
  register: apt_cache_result
  retries: 5
  delay: 30
  until: apt_cache_result is succeeded
  throttle: "{{ 999 if (parallel_execution | default({})).package_installation | default(1) == 0 else (parallel_execution | default({})).package_installation | default(1) }}"

- name: Install packages on Debian/Ubuntu
  apt:
    name: "{{ ubuntu_packages }}"
    state: present
  when: ansible_os_family == "Debian"
  register: apt_install_result
  retries: 5
  delay: 30
  until: apt_install_result is succeeded
  throttle: "{{ 999 if (parallel_execution | default({})).package_installation | default(1) == 0 else (parallel_execution | default({})).package_installation | default(1) }}"

- name: Install packages on RHEL/CentOS
  package:
    name: "{{ rhel_packages }}"
    state: present
  when: ansible_os_family == "RedHat"
  register: yum_install_result
  retries: 3
  delay: 10
  until: yum_install_result is succeeded

- name: Install optional packages on RHEL/CentOS
  package:
    name: "{{ rhel_optional_packages }}"
    state: present
  when: ansible_os_family == "RedHat"
  ignore_errors: yes
  register: yum_optional_install_result

- name: Install distribution-specific packages
  package:
    name: "{{ package_map[item][ansible_os_family] }}"
    state: present
  loop:
    - nfs_client
    - time_sync
  when: package_map[item][ansible_os_family] is defined
  ignore_errors: true

# Master-only package installation (for installs group)
- name: Install master-only packages on Debian/Ubuntu
  apt:
    name: "{{ master_only_packages }}"
    state: present
  when: 
    - ansible_os_family == "Debian"
    - inventory_hostname in groups['installs']
  retries: 3
  delay: 10
  ignore_errors: true

- name: Install master-only packages on RHEL/CentOS
  package:
    name: "{{ master_only_rhel_packages }}"
    state: present
  when: 
    - ansible_os_family == "RedHat"
    - inventory_hostname in groups['installs']
  retries: 3
  delay: 10
  ignore_errors: true

# Remove helm secrets plugin after helm/helmfile installation
- name: Remove helm secrets plugin
  shell: helm plugin remove secrets
  when: inventory_hostname in groups['installs']
  ignore_errors: true
  become_user: root

# GPU Detection (no driver installation)
- name: Check for NVIDIA devices
  shell: lspci | grep -i NVIDIA
  register: nvidia_devices
  ignore_errors: true
  changed_when: false
  tags: gpu

- name: Set GPU detection fact
  set_fact:
    has_nvidia_gpu: "{{ nvidia_devices.stdout != '' }}"
    cacheable: yes
  tags: gpu

- name: Display GPU detection result
  debug:
    msg: "NVIDIA GPU detected: {{ has_nvidia_gpu }}"
  tags: gpu

- name: Create ldconfig symlink for NVIDIA
  file:
    src: /sbin/ldconfig
    dest: /sbin/ldconfig.real
    state: link
  when: has_nvidia_gpu | default(false) | bool
  ignore_errors: yes
  tags: gpu

# Configure environment variables
- name: Add HELMFILE_CONFIG to bashrc
  lineinfile:
    path: /root/.bashrc
    line: 'export HELMFILE_CONFIG=config_default.yaml'
    state: present
    create: yes

- name: Add /usr/local/bin to PATH in bashrc
  lineinfile:
    path: /root/.bashrc
    line: 'export PATH="/usr/local/bin:$PATH"'
    state: present
    create: yes