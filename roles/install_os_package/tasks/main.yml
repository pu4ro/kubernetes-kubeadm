---
# Cross-platform package installation

# Ubuntu Repository Setup (before package installation)
- name: Setup Ubuntu repository before package installation
  block:
    - name: Create APT sources list entry for custom repository
      copy:
        content: |
          # Ubuntu Local Repository
          # Managed by Ansible - Do not edit manually
          deb [{{ 'trusted=yes ' if ubuntu_repo_trusted | default(true) else '' }}]{{ ubuntu_repo_url }} {{ ubuntu_repo_components | default('./') }}
        dest: "{{ ubuntu_repo_sources_file | default('/etc/apt/sources.list.d/ubuntu-local-repo.list') }}"
        owner: root
        group: root
        mode: '0644'
      register: ubuntu_repo_created

    - name: Backup original sources.list (first time only)
      copy:
        src: /etc/apt/sources.list
        dest: /etc/apt/sources.list.backup
        remote_src: true
        force: false
      ignore_errors: true

    # Ubuntu 24.04: Disable all other apt sources except custom repo
    - name: Disable default Ubuntu sources on 24.04
      block:
        - name: Find all files in sources.list.d (except custom repo)
          find:
            paths: /etc/apt/sources.list.d
            patterns: "*.list,*.sources"
            excludes:
              - "ubuntu-local-repo.list"
          register: other_sources

        - name: Disable other source files by renaming to .disabled
          command: mv "{{ item.path }}" "{{ item.path }}.disabled"
          loop: "{{ other_sources.files }}"
          loop_control:
            label: "{{ item.path | basename }}"
          when: not item.path.endswith('.disabled')
          ignore_errors: true

        - name: Disable /etc/apt/sources.list if exists and not empty
          block:
            - name: Check if sources.list exists and has content
              stat:
                path: /etc/apt/sources.list
              register: sources_list_stat

            - name: Rename sources.list to sources.list.disabled
              command: mv /etc/apt/sources.list /etc/apt/sources.list.disabled
              when:
                - sources_list_stat.stat.exists
                - sources_list_stat.stat.size > 0
                - not sources_list_stat.stat.islnk
              ignore_errors: true
      when: ansible_distribution_version is version('24.04', '>=')

    - name: Update APT cache after adding custom repository
      apt:
        update_cache: yes
        cache_valid_time: 0
      when: ubuntu_repo_created is changed
      register: apt_custom_update
      retries: 3
      delay: 5
      until: apt_custom_update is succeeded

    - name: Display custom repository status
      debug:
        msg: "Custom Ubuntu repository configured: {{ ubuntu_repo_url }}{{ ' (other sources disabled)' if ansible_distribution_version is version('24.04', '>=') else '' }}"
  when:
    - ansible_os_family == "Debian"
    - enable_ubuntu_repo | default(false) | bool
    - ubuntu_repo_url | default('') != ''

- name: Update package cache (Debian/Ubuntu)
  apt:
    update_cache: yes
    cache_valid_time: 3600
    update_cache_retries: 5
    update_cache_retry_max_delay: 30
  when: ansible_os_family == "Debian"
  register: apt_cache_result
  retries: 5
  delay: 30
  until: apt_cache_result is succeeded
  throttle: "{{ 999 if (parallel_execution | default({})).package_installation | default(1) == 0 else (parallel_execution | default({})).package_installation | default(1) }}"

- name: Install packages on Debian/Ubuntu
  apt:
    name: "{{ ubuntu_packages }}"
    state: present
  when: ansible_os_family == "Debian"
  register: apt_install_result
  retries: 5
  delay: 30
  until: apt_install_result is succeeded
  throttle: "{{ 999 if (parallel_execution | default({})).package_installation | default(1) == 0 else (parallel_execution | default({})).package_installation | default(1) }}"

- name: Install optional packages on Debian/Ubuntu (nerdctl, buildkit)
  apt:
    name: "{{ ubuntu_optional_packages }}"
    state: present
  when:
    - ansible_os_family == "Debian"
    - enable_nerdctl_buildkit | default(false) | bool
  register: apt_optional_install_result
  retries: 5
  delay: 30
  until: apt_optional_install_result is succeeded
  ignore_errors: yes
  throttle: "{{ 999 if (parallel_execution | default({})).package_installation | default(1) == 0 else (parallel_execution | default({})).package_installation | default(1) }}"

- name: Install packages on RHEL/CentOS
  package:
    name: "{{ rhel_packages }}"
    state: present
  when: ansible_os_family == "RedHat"
  register: yum_install_result
  retries: 3
  delay: 10
  until: yum_install_result is succeeded

- name: Install RHEL 8 specific packages (containerd.io)
  package:
    name: "{{ rhel8_packages }}"
    state: present
  when:
    - ansible_os_family == "RedHat"
    - ansible_distribution_major_version == "8"
  register: yum_rhel8_install_result
  retries: 3
  delay: 10
  until: yum_rhel8_install_result is succeeded

- name: Install RHEL 9 specific packages (containerd.io)
  package:
    name: "{{ rhel9_packages }}"
    state: present
  when:
    - ansible_os_family == "RedHat"
    - ansible_distribution_major_version == "9"
  register: yum_rhel9_install_result
  retries: 3
  delay: 10
  until: yum_rhel9_install_result is succeeded

- name: Install optional packages on RHEL/CentOS
  package:
    name: "{{ rhel_optional_packages }}"
    state: present
  when: ansible_os_family == "RedHat"
  ignore_errors: yes
  register: yum_optional_install_result

- name: Install distribution-specific packages
  package:
    name: "{{ package_name_map[item][ansible_os_family] }}"
    state: present
  loop:
    - nfs_client
    - time_sync
  when: package_name_map[item][ansible_os_family] is defined
  ignore_errors: true

# Master-only package installation (for installs group)
- name: Install master-only packages on Debian/Ubuntu
  apt:
    name: "{{ ubuntu_master_only_packages }}"
    state: present
  when:
    - ansible_os_family == "Debian"
    - inventory_hostname in groups['installs']
  retries: 3
  delay: 10
  ignore_errors: true

- name: Install master-only packages on RHEL/CentOS
  package:
    name: "{{ rhel_master_only_packages }}"
    state: present
  when:
    - ansible_os_family == "RedHat"
    - inventory_hostname in groups['installs']
  retries: 3
  delay: 10
  ignore_errors: true

# Install helmfile (distribution-specific package name, optional)
- name: Install helmfile on Debian/Ubuntu
  apt:
    name: "{{ package_name_map.helmfile.Debian }}"
    state: present
  when:
    - ansible_os_family == "Debian"
    - inventory_hostname in groups['installs']
    - enable_helmfile | default(false) | bool
  retries: 3
  delay: 10
  ignore_errors: true

- name: Install helmfile on RHEL/CentOS
  package:
    name: "{{ package_name_map.helmfile.RedHat }}"
    state: present
  when:
    - ansible_os_family == "RedHat"
    - inventory_hostname in groups['installs']
    - enable_helmfile | default(false) | bool
  retries: 3
  delay: 10
  ignore_errors: true

# Remove helm secrets plugin after helm/helmfile installation
- name: Remove helm secrets plugin
  shell: helm plugin remove secrets
  when: inventory_hostname in groups['installs']
  ignore_errors: true
  become_user: root

# GPU Detection (no driver installation)
- name: Check for NVIDIA devices
  shell: lspci | grep -i NVIDIA
  register: nvidia_devices
  ignore_errors: true
  changed_when: false
  tags: gpu

- name: Set GPU detection fact
  set_fact:
    has_nvidia_gpu: "{{ nvidia_devices.stdout != '' }}"
    cacheable: yes
  tags: gpu

- name: Display GPU detection result
  debug:
    msg: "NVIDIA GPU detected: {{ has_nvidia_gpu }}"
  tags: gpu

- name: Create ldconfig symlink for NVIDIA
  file:
    src: /sbin/ldconfig
    dest: /sbin/ldconfig.real
    state: link
  when: has_nvidia_gpu | default(false) | bool
  ignore_errors: yes
  tags: gpu

# Configure environment variables
- name: Add HELMFILE_CONFIG to bashrc
  lineinfile:
    path: /root/.bashrc
    line: 'export HELMFILE_CONFIG=config_default.yaml'
    state: present
    create: yes

- name: Add /usr/local/bin to PATH in bashrc
  lineinfile:
    path: /root/.bashrc
    line: 'export PATH="/usr/local/bin:$PATH"'
    state: present
    create: yes