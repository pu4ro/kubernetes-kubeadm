---
- name: Ensure local registry data directory exists
  file:
    path: "{{ local_registry_data_dir }}"
    state: directory
    mode: '0755'

- name: Check if registry image tar exists
  stat:
    path: "{{ local_registry_image_tar }}"
  register: registry_image_tar_info
  when: local_registry_image_tar | default('') | length > 0

- name: Load registry image tar with nerdctl
  command: nerdctl load -i {{ local_registry_image_tar }}
  when:
    - local_registry_image_tar | default('') | length > 0
    - registry_image_tar_info.stat.exists

- name: Stop and remove existing local registry container
  command: nerdctl rm -f {{ local_registry_container_name }}
  failed_when: false

- name: Run local docker registry with nerdctl
  command: >
    nerdctl run -d --name {{ local_registry_container_name }}
    --restart always
    -p {{ local_registry_host_port }}:{{ local_registry_container_port }}
    -v {{ local_registry_data_dir }}:/var/lib/registry
    {% for arg in local_registry_additional_args %}{{ arg }} {% endfor %}
    {{ local_registry_image }}
