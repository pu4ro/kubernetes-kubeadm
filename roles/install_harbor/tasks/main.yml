---
- name: Check if Harbor is already installed
  community.kubernetes.helm_info:
    name: harbor
    namespace: harbor
  register: harbor_installed

- name: Install or Upgrade Harbor Helm chart
  community.kubernetes.helm:
    name: harbor
    chart_ref: helm/harbor
    release_namespace: harbor
    create_namespace: true
    state: present
    values: "{{ harbor_values | combine({'externalURL': item}) }}"
  loop: "{{ harbor_values.externalURLs }}"
  when: harbor_installed.helm_info is undefined or harbor_installed.helm_info.resources | length == 0

- name: Wait for Harbor to be ready
  community.kubernetes.k8s_info:
    api_version: apps/v1
    kind: Deployment
    namespace: harbor
    name: harbor
  register: harbor_deployment
  until: harbor_deployment.resources[0].status.readyReplicas == harbor_deployment.resources[0].status.replicas
  retries: 30
  delay: 10