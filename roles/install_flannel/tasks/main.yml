---
- name: Deploy kube-flannel configuration
  template:
    src: kube-flannel.yml.j2
    dest: /root/kube-flannel.yml
  become: yes

- name: Check if kube-apiserver container is running
  shell: crictl ps | grep kube-apiserver
  register: kube_apiserver_status
  retries: 30               # 최대 30번 재시도
  delay: 10                 # 각 재시도 사이에 10초 대기
  until: kube_apiserver_status.rc == 0
  ignore_errors: yes

- name: Debug the output of kube-apiserver status
  debug:
    msg: "{{ kube_apiserver_status.stdout }}"
    
- name: Check if flannel DaemonSet exists
  shell: kubectl get daemonset -n kube-flannel kube-flannel-ds --no-headers 2>/dev/null | wc -l
  register: flannel_ds_exists
  changed_when: false
  failed_when: false
  when: 
    - inventory_hostname == groups['masters'][0]
    - kube_apiserver_status.rc == 0

- name: Apply kube-flannel configuration (new installation)
  command: kubectl apply -f /root/kube-flannel.yml
  when: 
    - inventory_hostname == groups['masters'][0]
    - kube_apiserver_status.rc == 0
    - flannel_ds_exists.stdout | default('0') | int == 0

- name: Display flannel status (already installed)
  debug:
    msg: "Flannel DaemonSet already exists, skipping installation"
  when: 
    - inventory_hostname == groups['masters'][0]
    - flannel_ds_exists.stdout | default('0') | int > 0

- name: Wait for all flannel pods to be ready
  shell: >
    kubectl get pods -n kube-system -o custom-columns=:status.phase --no-headers | grep -v Running || true
  register: not_running_flannel_pods
  until: not_running_flannel_pods.stdout == ""
  retries: 12
  delay: 10
  become: true