---
- name: Configure sysctl for Kubernetes networking
  become: yes
  template:
    src: k8s.conf.j2
    dest: /etc/sysctl.d/k8s.conf
    owner: root
    group: root
    mode: '0644'
  notify: reload sysctl

- name: reload sysctl
  command: sysctl --system
  become: yes

- name: Apply soft nofile limit temporarily
  command: ulimit -Sn 100000
  ignore_errors: true

- name: Apply hard nofile limit temporarily
  command: ulimit -Hn 100000
  ignore_errors: true

- name: Add soft nofile limit to /etc/security/limits.conf
  lineinfile:
    path: /etc/security/limits.conf
    state: present
    line: "* soft nofile 100000"
    insertafter: EOF

- name: Add hard nofile limit to /etc/security/limits.conf
  lineinfile:
    path: /etc/security/limits.conf
    state: present
    line: "* hard nofile 100000"
    insertafter: EOF