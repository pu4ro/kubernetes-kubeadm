---
# Configure sysctl parameters for Kubernetes

- name: Load kernel modules
  ansible.builtin.command: modprobe {{ item }}
  loop: "{{ k8s_kernel_modules }}"
  changed_when: false
  tags:
    - sysctl
    - kernel-modules

- name: Ensure kernel modules load on boot
  ansible.builtin.copy:
    dest: /etc/modules-load.d/k8s.conf
    content: |
      # Kubernetes required kernel modules
      br_netfilter
      overlay
      ip_vs
      ip_vs_rr
      ip_vs_wrr
      ip_vs_sh
      nf_conntrack
    mode: '0644'
  tags:
    - sysctl
    - kernel-modules

# RHEL/CentOS specific: Disable SELinux
- name: Disable SELinux immediately
  ansible.builtin.command: setenforce 0
  when: 
    - ansible_os_family == "RedHat"
    - ansible_selinux.status is defined
    - ansible_selinux.status == "enabled"
  failed_when: false
  changed_when: false
  tags:
    - sysctl
    - selinux

- name: Disable SELinux permanently
  ansible.builtin.lineinfile:
    path: /etc/selinux/config
    regexp: '^SELINUX='
    line: 'SELINUX=disabled'
    state: present
  when: ansible_os_family == "RedHat"
  tags:
    - sysctl
    - selinux

# RHEL/CentOS specific: Disable firewalld
- name: Stop and disable firewalld service
  ansible.builtin.systemd:
    name: firewalld
    state: stopped
    enabled: no
  when: ansible_os_family == "RedHat"
  failed_when: false
  tags:
    - sysctl
    - firewall

- name: Configure sysctl parameters for Kubernetes
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: /etc/sysctl.d/k8s.conf
    reload: yes
  loop: "{{ k8s_sysctl_params | dict2items }}"
  tags:
    - sysctl
    - sysctl-params

- name: Disable swap immediately
  ansible.builtin.command: swapoff -a
  when: ansible_swaptotal_mb > 0
  changed_when: false
  tags:
    - sysctl
    - swap

- name: Remove swap from /etc/fstab
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '^\s*[^#].*\s+swap\s+'
    state: absent
  tags:
    - sysctl
    - swap

- name: Verify sysctl settings
  ansible.builtin.command: sysctl --system
  changed_when: false
  tags:
    - sysctl
    - verify
