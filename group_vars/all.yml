---
# Basic Kubernetes Cluster Configuration

# Kubernetes Settings
kubernetes_version: '1.27.14'
dns_domain: cluster.local
service_subnet: 10.96.0.0/12
pod_subnet: 10.244.0.0/16

# High Availability Settings (for multi-master setup)
master_ha: true
kube_vip_port: 6443
kube_vip_interface: ens18
kube_vip_address: 192.168.135.30  # Uncomment for HA setup

# Container Runtime
containerd_version: "1.7.6"

# System Configuration
set_timezone: Asia/Seoul

# NTP/Chrony Configuration
use_local_ntp: true                    # true: master1 as NTP server, false: use external NTP
external_ntp_servers: {}             # External NTP servers
  #  - "pool.ntp.org"
  #  - "time.google.com"
  #  - "time.cloudflare.com"
cluster_network: "192.168.0.0/16"     # Network range allowed to access local NTP server

# Cross-platform service and config paths
chrony_service_name: "{{ 'chronyd' if ansible_os_family == 'RedHat' else 'chrony' }}"
chrony_config_path: "{{ '/etc/chrony.conf' if ansible_os_family == 'RedHat' else '/etc/chrony/chrony.conf' }}"

# Network Plugin (flannel is default)
network_plugin: "flannel"

# Master Node Scheduling (allow pods on master for single-node setup)
allow_master_scheduling: true

# Certificate Extension (extend certificates to 10 years)
extend_k8s_certificates: true

# Parallel Execution Control
# Set how many hosts to run simultaneously during installation
# 1 = sequential (one at a time), 0 = all hosts in parallel
parallel_execution:
  system_preparation: 0     # How many hosts for system prep phase (packages, containerd)
  package_installation: 0   # How many hosts for apt/yum operations simultaneously
  kubernetes_installation: 0  # How many hosts for kubernetes installation (0 = all parallel)

# Example configurations:
# For fast installation on reliable network (all parallel):
# parallel_execution:
#   system_preparation: 0
#   package_installation: 0  
#   kubernetes_installation: 0
#
# For mixed approach (packages sequential, k8s parallel):
# parallel_execution:
#   system_preparation: 1
#   package_installation: 1
#   kubernetes_installation: 0
#
# For completely sequential installation:
# parallel_execution:
#   system_preparation: 1
#   package_installation: 1
#   kubernetes_installation: 1

# Local Repository Configuration (for RedHat/CentOS systems)
# Enable local repository setup with web server
# Supports both directory-based repo and ISO-based repo
setup_local_repo: true

# Directory-based repository
# If yum_repo_directory exists, it will be served via HTTP
use_yum_repo_directory: true
yum_repo_directory: "/root/yum-repo"
yum_repo_web_port: 8080

# ISO-based repository  
# Mount ISO file and serve via HTTP
use_iso_repo: false
iso_file_path: "/root/rhel-8.10-x86_64-dvd.iso"  # Path to ISO file
iso_mount_point: "/mnt/cdrom"
iso_device: "/dev/sr0"  # Use this if mounting from CD/DVD drive instead of ISO file
use_iso_device: false   # Set to true to use device instead of ISO file

# Web server configuration for local repo
local_repo_web_server: "httpd"  # httpd or nginx
local_repo_server_ip: "{{ ansible_default_ipv4.address }}"

# Package Repository URLs (for offline installation)
repo_url:
  centos: "http://192.168.135.31:8080/yum-repo"
  ubuntu: "http://192.168.134.102/ubuntu_22.04.5"

# Container Registry Settings (basic Docker configuration)
insecure_registries: 
  #- "192.168.1.10:5000"           # Local registry example
  # - "harbor.yourdomain.com"     # Harbor registry example
  # - "registry.local"            # Custom registry example
docker_log_max_size: "100m"

# Kubernetes pause container image
pause_image: "cr.makina.rocks/external-hub/kubernetes/pause:3.9"

# NVIDIA runtime support for containerd
nvidia_runtime: false

# GPU Driver Installation
# Set install_gpu_driver to true to install NVIDIA GPU drivers
# Requires NVIDIA devices to be present in the system
# Driver version can be configured with driver_version variable
install_gpu_driver: false
driver_version: "570.124.06"

# Docker Registry Credentials Configuration
# Set docker_login_required to true to enable registry authentication
# Supports multiple registries with different protocols (http/https)
# 
# Usage with tags:
#   ansible-playbook site.yml --tags docker-credentials        # Full setup
#   ansible-playbook site.yml --tags nerdctl-login            # Login only
#   ansible-playbook site.yml --tags containerd-config        # Config only
#   ansible-playbook site.yml --tags restart-kubelet          # Restart only
#
docker_login_required: true
docker_registries:
  # Example configuration for multiple registries:
  - registry: "cr.makina.rocks"
    protocol: "https"  # https (default) or http
    username: "mrx.dev"
    password: "GMflzHdAeR3KhGgXoecXR3lTKO0lSX5O"
  - registry: "harbor.runway.test"
    protocol: "http"   # for insecure registries
    username: "admin" 
    password: "Harbor12345"
  # - registry: "gcr.io"
  #   protocol: "https"
  #   username: "_json_key"
  #   password: "{{ gcp_service_account_key }}"

# Registry Host Mapping (for /etc/hosts configuration)
# Map registry domains to their IP addresses
# This will be added to /etc/hosts along with inventory host information
# 
# Usage with tags:
#   ansible-playbook site.yml --tags hosts-config    # Update /etc/hosts only
#   ansible-playbook site.yml --tags common          # Full common setup
#
registry_hosts:
  "harbor.runway.test": "192.168.135.28"
  # Add more registry domains and their IPs as needed

# CoreDNS Hosts Configuration (add registry hosts to CoreDNS)
configure_coredns_hosts: true

# ansible-playbook -i inventory.ini site.yml --tags coredns-hosts -e

# NFS Server Configuration
# Configure NFS server on the first server with /nfs export
# Set nfs_server_enabled to true to enable NFS server setup
# The /nfs directory will be exported with rw,sync,no_root_squash options
# 
# Usage with tags:
#   ansible-playbook site.yml --tags nfs-server        # Full NFS server setup
#   ansible-playbook site.yml --tags nfs-install       # Install NFS packages only
#   ansible-playbook site.yml --tags nfs-config        # Configure exports only
#   ansible-playbook site.yml --tags nfs-service       # Restart NFS services only
#
nfs_server_enabled: true
nfs_exports:
  - path: "/nfs"
    options: "rw,sync,no_root_squash"
    clients: "*"  # Allow all clients, can be restricted to specific networks
nfs_export_directories:
  - "/nfs" 