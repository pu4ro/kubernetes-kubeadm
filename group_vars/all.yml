---
# Basic Kubernetes Cluster Configuration

# Kubernetes Settings
kubernetes_version: '1.27.14'
dns_domain: cluster.local
service_subnet: 10.96.0.0/12
pod_subnet: 10.244.0.0/16

# High Availability Settings (for multi-master setup)
master_ha: true
kube_vip_port: 6443
kube_vip_interface: ens18
kube_vip_address: 192.168.135.89  # Uncomment for HA setup

# Container Runtime
containerd_version: "1.7.6"
containerd_limit_nproc: 100000      # systemd LimitNPROC for containerd.service
containerd_limit_nofile: 100000     # systemd LimitNOFILE for containerd.service
enable_local_registry: false
local_registry_image: "registry:2"
local_registry_image_tar: "/root/docker.tar.gz"
local_registry_container_name: "local-registry"
local_registry_host_port: 80
local_registry_container_port: 5000
local_registry_data_dir: "/opt/local-registry/data"
local_registry_additional_args: []

# Containerd Data Directory Configuration
# Set custom data directory for containerd (default: /var/lib/containerd)
# The actual path will be: {containerd_data_base_dir}/{hostname}
# Example: /data/containerd/worker1, /data/containerd/worker2
# Leave empty or comment out to use default /var/lib/containerd
containerd_data_base_dir: "/data"  # Base directory for containerd data
# containerd_data_base_dir: ""  # Use this to disable custom path and use default

# System Configuration
set_timezone: Asia/Seoul

# NTP/Chrony Configuration
use_local_ntp: true                    # true: master1 as NTP server, true: use external NTP
external_ntp_servers: {}             # External NTP servers
  #  - "pool.ntp.org"
  #  - "time.google.com"
  #  - "time.cloudflare.com"
cluster_network: "192.168.0.0/16"     # Network range allowed to access local NTP server

# Cross-platform service and config paths
chrony_service_name: "{{ 'chronyd' if ansible_os_family == 'RedHat' else 'chrony' }}"
chrony_config_path: "{{ '/etc/chrony.conf' if ansible_os_family == 'RedHat' else '/etc/chrony/chrony.conf' }}"

# Network Plugin (flannel is default)
network_plugin: "flannel"

# Master Node Scheduling (allow pods on master for single-node setup)
allow_master_scheduling: true

# Certificate Extension (extend certificates to 10 years)
extend_k8s_certificates: true

# Parallel Execution Control
# Set how many hosts to run simultaneously during installation
# 1 = sequential (one at a time), 0 = all hosts in parallel
parallel_execution:
  system_preparation: 0     # How many hosts for system prep phase (packages, containerd)
  package_installation: 0   # How many hosts for apt/yum operations simultaneously
  kubernetes_installation: 0  # How many hosts for kubernetes installation (0 = all parallel)

# Example configurations:
# For fast installation on reliable network (all parallel):
# parallel_execution:
#   system_preparation: 0
#   package_installation: 0  
#   kubernetes_installation: 0
#
# For mixed approach (packages sequential, k8s parallel):
# parallel_execution:
#   system_preparation: 1
#   package_installation: 1
#   kubernetes_installation: 0
#
# For completely sequential installation:
# parallel_execution:
#   system_preparation: 1
#   package_installation: 1
#   kubernetes_installation: 1

# Package Repository URLs (for offline installation)
repo_url:
  centos: "http://192.168.1.10:8080/repo/"
  ubuntu: "http://192.168.134.102/ubuntu_22.04.5"

# Ubuntu APT Repository Configuration
# Enable this to use custom Ubuntu repository (local or HTTP)
# Example: Apache HTTP server serving local packages
enable_ubuntu_repo: false
ubuntu_repo_url: ""  # Example: "http://192.168.1.100:8080/ubuntu-repo"
ubuntu_repo_components: "./"
ubuntu_repo_trusted: true
ubuntu_repo_update_cache: true

# Container Registry Settings (basic Docker configuration)
insecure_registries:
  #- "192.168.1.10:5000"           # Local registry example
  # - "harbor.yourdomain.com"     # Harbor registry example
  # - "registry.local"            # Custom registry example
docker_log_max_size: "100m"

# Containerd Registry Authentication Configuration
# Configure authentication for registries in containerd config.toml
# This complements docker_registries (used for nerdctl login)
#
# Usage:
#   ansible-playbook site.yml --tags containerd-config
#
containerd_registry_auth:
  # Example configurations:
  - registry: "registry.test"
    insecure_skip_verify: true
    username: ""          # Leave empty for no auth
    password: ""
    auth: ""
    identitytoken: ""
  - registry: "registry.local"
    insecure_skip_verify: true
    username: ""
    password: ""
    auth: ""
    identitytoken: ""
  # - registry: "cr.makina.rocks"
  #   insecure_skip_verify: false
  #   username: "your-username"
  #   password: "your-password"
  #   auth: ""              # Optional: base64 encoded username:password
  #   identitytoken: ""     # Optional: for token-based auth
  # - registry: "harbor.yourdomain.com"
  #   insecure_skip_verify: true
  #   username: "admin"
  #   password: "Harbor12345"
  #   auth: ""
  #   identitytoken: ""

# Kubernetes pause container image
pause_image: "cr.makina.rocks/external-hub/kubernetes/pause:3.9"

# NVIDIA runtime support for containerd
# GPU will be auto-detected via lspci, no manual configuration needed
# No driver installation by Ansible - install NVIDIA Container Toolkit separately

# Docker Registry Credentials Configuration
# Set docker_login_required to true to enable registry authentication
# Supports multiple registries with different protocols (http/https)
# 
# Usage with tags:
#   ansible-playbook site.yml --tags docker-credentials        # Full setup
#   ansible-playbook site.yml --tags nerdctl-login            # Login only
#   ansible-playbook site.yml --tags containerd-config        # Config only
#   ansible-playbook site.yml --tags restart-kubelet          # Restart only
#
docker_login_required: true
docker_registries:
  # Example configuration for multiple registries:
  - registry: "cr.makina.rocks"
    protocol: "https"  # https (default) or http
    username: "mrx.dev"
    password: "GMflzHdAeR3KhGgXoecXR3lTKO0lSX5O"
  - registry: "harbor.runway.test"
    protocol: "http"   # for insecure registries
    username: "admin" 
    password: "Harbor12345"
  # - registry: "gcr.io"
  #   protocol: "https"
  #   username: "_json_key"
  #   password: "{{ gcp_service_account_key }}"

# Registry Host Mapping (for /etc/hosts configuration)
# Map registry domains to their IP addresses
# This will be added to /etc/hosts along with inventory host information
# 
# Usage with tags:
#   ansible-playbook site.yml --tags hosts-config    # Update /etc/hosts only
#   ansible-playbook site.yml --tags common          # Full common setup
#
registry_hosts:
  "harbor.runway.test": "192.168.135.28"
  # Add more registry domains and their IPs as needed

# CoreDNS Hosts Configuration (add registry hosts to CoreDNS)
configure_coredns_hosts: true

# ansible-playbook -i inventory.ini site.yml --tags coredns-hosts -e
